# Valheim Telegram Notify

Valheim Telegram Notify — это простой скрипт на bash, который проверяет log-файл сервера Valheim и отправляет уведомления в телеграм-чат, если находит нужные строки. Он создан для простоты использования и должен работать на большинстве дистрибутивов Linux.

## Поддерживаемые уведомления
Скрипт распознает 11 событий, которые можно извлечь из журнала консоли сервера valheim:
1. Игрок присоединился.
2. Игрок отключился.
3. Персонаж заспавнился.
4. Персонаж умер.
5. Все игроки в сети легли спать, чтобы пропустить ночь, и начался новый день.
6. Запускается случайное событие, см. https://valheim.fandom.com/wiki/Events
7. Запуск сервера и загрузка мира.
8. Выключение сервера.
9. Мало оперативной памяти.
10. Мало места на диске.
11. Необходимость обновления сервера.

Если нужно отключить уведомления о каком-то событии, просто закомментируйте блок, отвечающий за проверку нужного события. Всё прокоментировано.  

## Подготовка
### Чтобы Valheim сохранял файл лога, в скрипт запуска сервера нужно добавить ключ -logfile. Пример:  
`./valheim_server.x86_64 -name "My server" -port 2456 -world "Dedicated" -password "secret" -logfile "/valheim-server/logs/valheim_log.txt"`  

### Предварительные требования для Telegram
Вам нужно создать телеграм-бота, добавить его в чат и получить ID этого чата.  
- Создайте телеграм-бота, следуя [этим инструкциям](https://core.telegram.org/bots#6-botfather) и скопируйте API-токен.  
- Добавьте бота в чат в Telegram.  
- В браузере откройте страницу ``https://api.telegram.org/bot<API-token>/getUpdates`` и запомните ID чата. Также можно узнать ID, например, отправив боту @username_to_id_bot ссылку на ваш чат.  
- Если у вас чат в формате тем, то узнать id темы можно в ссылке в шапке темы. Например: https://t.me/chatname/1   - где 1 - это id темы.  

## Установка и настройка
- Разместите файлы **valheim-tg-notify.sh** и **messages.conf** на вашем сервере, желательно в отдельную директорию, так как скрипт создаст файл конфигурации и файл usserlist при запуске.  
- Убедитесь, что пользователь, от имени которого будет запускаться скрипт, имеет доступ на запись в директорию со скриптом и на чтение лог-файла valheim.  
- Выдайте право на запуск скрипта: `chmod +x valheim-tg-notify.sh`.  
- Запустите скрипт в первый раз `bash .\valheim-tg-notify.sh` - это создаст файл настроек `valheim-tg-notify.conf` рядом с файлом скрипта.  
- Заполните настройки:  
  - `LOGFILE`: Полный путь до файла лога сервера Valheim. Тот файл, что указали в параметрах запуска -logfile.  
  - `KEY`: API-токен вашего телеграм-бота.  
  - `CHATID`: ID телеграм-чата, куда бот будет отправлять уведомления.  
  - `THREAD_ID`: Если чат имеет формат форума, то укажите ID темы. Если это обычный чат, оставьте пустым.  
- ~~Добавьте 64-битные Steam ID с соответствующими именами пользователей в usernames.txt~~ Больше не требуется, в скрипт добавлена функция подтягивания никнейма из Steam по SteamID. Однако, если вы хотите, вы можете изменить имена или добавить ID и имена, сам скрипт не перезапишет существующие данные в этом файле.
- По желанию можно отредактировать файл `messages.conf`, чтобы настроить тексты уведомлений так, как вам хочется.

## Запуск
Вы можете просто запустить скрипт командой ``bash .\valheim-tg-notify.sh``, но работа скрипта будет возможна, пока открыт терминал, в котором был запущен скрипт.  

## Для автоматического запуска при загрузке системы можно создать systemd сервис:
   1. Создайте файл сервиса: `sudo touch /etc/systemd/system/valheim-tg-notify.service`  
   2. Добавьте в созданный файл следующее содержимое:
      ```
      [Unit]
      Description=Telegram notification service for events on the Valheim server
      After=network.target
      Before=valheim.service
      
      [Service]
      Type=simple
      User=root
      WorkingDirectory=/root/valheim-tg-notify
      ExecStart=/bin/bash /root/valheim-tg-notify/valheim-tg-notify.sh
      Restart=always
      RestartSec=5
      
      [Install]
      WantedBy=multi-user.target
      ```
      - Вместо `root` введите имя пользователя, от имени которого хотите запускать сервис со скриптом. У этого пользователя, соответственно, должен быть доступ на чтение файла лога Valheim и на запись в папку со скриптом.
      - Вместо `/root/valheim-tg-notify` укажите полный путь до директории со скриптом.
      - Вместо `/root/valheim-tg-notify/valheim-tg-notify.sh` введите полный путь до скрипта.  

## Имена пользователей Steam
Сообщения о подключении и отключении в журнале сервера упоминают 64-битный Steam ID игрока, подключающегося к серверу. Скрипт попытается найти этот Steam ID и сохранит ID вместе с именем пользователя в usernames.txt. Если скрипт не найдет соответствующий Steam ID в usernames.txt, он сообщит ``Неизвестный (Steam ID)`` в уведомлении.  
Сообщения о смерти и (пере)рождении в журнале упоминают имя персонажа Valheim, с которым игрок вошел в мир, поэтому скрипт непосредственно парсит их из журнала.



